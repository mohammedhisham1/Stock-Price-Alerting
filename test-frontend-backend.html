<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
        }

        .response {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>Stock Price Alerting - Backend Connection Test</h1>

    <div id="status" class="status info">Ready to test...</div>

    <div>
        <button onclick="testAPI()">Test API Connection</button>
        <button onclick="testRegister()">Test User Registration</button>
        <button onclick="testLogin()">Test User Login</button>
        <button onclick="testStocks()">Test Stocks API</button>
    </div>

    <div id="response" class="response" style="display: none;"></div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('test_token');

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function showResponse(data) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = JSON.stringify(data, null, 2);
            responseDiv.style.display = 'block';
        }

        async function testAPI() {
            setStatus('Testing basic API connection...');
            try {
                const response = await axios.get(`${API_URL}/`);
                setStatus('✅ API connection successful!', 'success');
                showResponse(response.data);
            } catch (error) {
                setStatus('❌ API connection failed: ' + error.message, 'error');
                showResponse(error.response?.data || error.message);
            }
        }

        async function testRegister() {
            setStatus('Testing user registration...');
            const userData = {
                username: 'testuser',
                email: 'testuser@example.com',
                password: 'testpass123',
                password2: 'testpass123',
                first_name: 'Test',
                last_name: 'User'
            };

            try {
                const response = await axios.post(`${API_URL}/auth/register/`, userData);
                setStatus('✅ Registration successful!', 'success');
                showResponse(response.data);
            } catch (error) {
                if (error.response?.status === 400 && error.response.data.errors?.username) {
                    setStatus('⚠️ User already exists, trying login...', 'info');
                    testLogin();
                } else {
                    setStatus('❌ Registration failed: ' + error.message, 'error');
                    showResponse(error.response?.data || error.message);
                }
            }
        }

        async function testLogin() {
            setStatus('Testing user login...');
            const loginData = {
                username: 'testuser',
                password: 'testpass123'
            };

            try {
                const response = await axios.post(`${API_URL}/auth/login/`, loginData);
                authToken = response.data.data.access;
                localStorage.setItem('test_token', authToken);
                setStatus('✅ Login successful! Token saved.', 'success');
                showResponse(response.data);
            } catch (error) {
                setStatus('❌ Login failed: ' + error.message, 'error');
                showResponse(error.response?.data || error.message);
            }
        }

        async function testStocks() {
            if (!authToken) {
                setStatus('⚠️ No auth token. Please login first.', 'error');
                return;
            }

            setStatus('Testing stocks API with authentication...');
            try {
                const response = await axios.get(`${API_URL}/stocks/`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });
                setStatus('✅ Stocks API successful!', 'success');
                showResponse(response.data);
            } catch (error) {
                setStatus('❌ Stocks API failed: ' + error.message, 'error');
                showResponse(error.response?.data || error.message);
            }
        }

        // Check if we have a token on load
        if (authToken) {
            setStatus('Found existing auth token. Ready to test authenticated endpoints.', 'info');
        }
    </script>
</body>

</html>