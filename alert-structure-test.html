<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert API Structure Test</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>Alert API Structure Test</h1>
    <button onclick="testAlertStructure()">Test Alert API Structure</button>
    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let authToken = null;

        function showResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message + (data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : '');
            resultsDiv.appendChild(resultDiv);
        }

        async function getAuthToken() {
            try {
                const response = await axios.post(`${API_URL}/auth/login/`, {
                    username: 'testuser',
                    password: 'testpass123'
                });
                return response.data.data.access;
            } catch (error) {
                throw new Error('Login failed: ' + error.message);
            }
        }

        async function testAlertStructure() {
            document.getElementById('results').innerHTML = '';

            try {
                showResult('üîê Getting authentication token...');
                authToken = await getAuthToken();
                showResult('‚úÖ Authentication successful', 'success');

                showResult('üì° Fetching alerts...');
                const alertsResponse = await axios.get(`${API_URL}/alerts/`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showResult('‚úÖ Alerts API response received', 'success');
                showResult('üìä Full Response Structure:', 'info', alertsResponse.data);

                // Test the various ways to access the alerts data
                const possiblePaths = [
                    { path: 'alertsResponse.data', value: alertsResponse.data },
                    { path: 'alertsResponse.data.results', value: alertsResponse.data.results },
                    { path: 'alertsResponse.data.results.data', value: alertsResponse.data.results?.data },
                    { path: 'alertsResponse.data.data', value: alertsResponse.data.data }
                ];

                showResult('üîç Testing different data access paths:');
                possiblePaths.forEach(({ path, value }) => {
                    const isArray = Array.isArray(value);
                    const type = value === null ? 'null' : typeof value;
                    const length = isArray ? value.length : 'N/A';
                    showResult(`${path}: ${type}${isArray ? ` (array with ${length} items)` : ''}`,
                        isArray ? 'success' : 'info');
                });

                // Show the correct path for alerts
                const alertsData = alertsResponse.data.results?.data || alertsResponse.data.data || alertsResponse.data.results || alertsResponse.data;
                if (Array.isArray(alertsData)) {
                    showResult(`‚úÖ Correct alerts data found: Array with ${alertsData.length} alerts`, 'success', alertsData);
                } else {
                    showResult('‚ùå No valid alerts array found', 'error');
                }

            } catch (error) {
                showResult('‚ùå Error: ' + error.message, 'error');
                console.error('Test error:', error);
            }
        }
    </script>
</body>

</html>